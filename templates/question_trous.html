{% extends "base.html" %}
{% block title %}Question √† trous{% endblock %}
{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Compl√©tez la phrase en glissant les mots dans les trous :</h2>
        <button type="button" class="btn btn-light border" onclick="confirmerRetourAccueil()">
            üè† Retour √† l'accueil
        </button>
    </div>
    <form id="formTrous" method="post" action="{{ url_for('lancer_test_trous', niveau=niveau) }}">
        <div id="enonce" class="mb-5"></div>
        <div class="mb-4">
            <h5>Mots √† choisir :</h5>
            <div id="rangements" class="d-flex gap-3 flex-wrap">
                {% for mot in choix_mots %}
                <div class="rangement">
                    <span class="mot badge bg-primary" draggable="true" data-mot="{{ mot }}">{{ mot }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% if index < total %}
        <button type="submit" class="btn btn-primary">Question suivante</button>
        {% else %}
        <button type="submit" class="btn btn-success">Terminer le test</button>
        {% endif %}
    </form>
    <div id="resultat" class="mt-4"></div>
</div>
<script>
// G√©n√©ration dynamique des trous √† partir de l'√©nonc√©
const rawEnonce = {{ question.probleme|tojson }};
const enonceDiv = document.getElementById('enonce');
let trouIndex = 0;
const parts = rawEnonce.split('[TROU]');
parts.forEach((part, idx) => {
    enonceDiv.append(document.createTextNode(part));
    if (idx < parts.length - 1) {
        const trou = document.createElement('span');
        trou.className = 'trou dropzone';
        trou.setAttribute('data-index', trouIndex);
        trouIndex++;
        enonceDiv.append(trou);
    }
});
// Drag & Drop JS (identique √† test_trous.html, adapt√©)
const rangements = document.querySelectorAll('.rangement');
const trous = document.querySelectorAll('.trou');
let motEnCours = null;
let isTouchDevice = 'ontouchstart' in window;

function initDraggableMots() {
    document.querySelectorAll('.mot').forEach(mot => {
        mot.setAttribute('draggable', 'true');

        // √âv√©nements drag and drop pour ordinateur
        mot.addEventListener('dragstart', e => {
            motEnCours = mot;
            e.dataTransfer.setData('text/plain', mot.dataset.mot);
            e.dataTransfer.effectAllowed = 'move';
        });

        // √âv√©nements tactiles pour smartphone
        if (isTouchDevice) {
            mot.addEventListener('touchstart', handleTouchStart, {passive: false});
            mot.addEventListener('touchmove', handleTouchMove, {passive: false});
            mot.addEventListener('touchend', handleTouchEnd, {passive: false});
        }

        // Clic pour mobile comme alternative
        mot.addEventListener('click', handleClick);
    });
}

// Variables pour le support tactile
let selectedMot = null;
let touchStartX = 0;
let touchStartY = 0;
let isDragging = false;
let ghostElement = null;

function handleTouchStart(e) {
    e.preventDefault();
    selectedMot = e.target;
    const touch = e.touches[0];
    touchStartX = touch.clientX;
    touchStartY = touch.clientY;
    selectedMot.style.opacity = '0.5';
}

function handleTouchMove(e) {
    e.preventDefault();
    if (!selectedMot) return;

    const touch = e.touches[0];
    const deltaX = Math.abs(touch.clientX - touchStartX);
    const deltaY = Math.abs(touch.clientY - touchStartY);

    if (deltaX > 10 || deltaY > 10) {
        if (!isDragging) {
            isDragging = true;
            createGhostElement(selectedMot, touch.clientX, touch.clientY);
        }
        updateGhostPosition(touch.clientX, touch.clientY);
    }
}

function handleTouchEnd(e) {
    e.preventDefault();
    if (!selectedMot) return;

    selectedMot.style.opacity = '';

    if (isDragging && ghostElement) {
        const touch = e.changedTouches[0];
        const elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
        const targetTrou = elementUnder?.closest('.trou');
        const targetRangement = elementUnder?.closest('.rangement');

        if (targetTrou) {
            placerMotDansTrou(selectedMot, targetTrou);
        } else if (targetRangement && targetRangement.children.length === 0) {
            placerMotDansRangement(selectedMot, targetRangement);
        }
    }

    removeGhostElement();
    selectedMot = null;
    isDragging = false;
}

function createGhostElement(mot, x, y) {
    ghostElement = document.createElement('div');
    ghostElement.className = 'ghost-mot';
    ghostElement.textContent = mot.textContent;
    ghostElement.style.cssText = `
        position: fixed;
        z-index: 9999;
        background: #0d6efd;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 1.1em;
        pointer-events: none;
        transform: translate(-50%, -50%) scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        transition: none;
        left: ${x}px;
        top: ${y}px;
    `;
    document.body.appendChild(ghostElement);
}

function updateGhostPosition(x, y) {
    if (ghostElement) {
        ghostElement.style.left = x + 'px';
        ghostElement.style.top = y + 'px';
    }
}

function removeGhostElement() {
    if (ghostElement) {
        document.body.removeChild(ghostElement);
        ghostElement = null;
    }
}

function handleClick(e) {
    if (!isTouchDevice) return;

    const mot = e.target;

    // Si un mot est d√©j√† s√©lectionn√©, le d√©s√©lectionner
    document.querySelectorAll('.mot-selected').forEach(m => {
        m.classList.remove('mot-selected');
    });

    // S√©lectionner le mot cliqu√©
    mot.classList.add('mot-selected');

    // Ajouter des gestionnaires de clic sur les trous et rangements
    addClickHandlers();
}

function addClickHandlers() {
    // Ajouter gestionnaires temporaires
    trous.forEach(trou => {
        trou.addEventListener('click', handleTrouClick, {once: true});
    });

    rangements.forEach(rangement => {
        rangement.addEventListener('click', handleRangementClick, {once: true});
    });
}

function handleTrouClick(e) {
    e.stopPropagation();
    const selectedMot = document.querySelector('.mot-selected');
    if (selectedMot) {
        placerMotDansTrou(selectedMot, e.currentTarget);
        selectedMot.classList.remove('mot-selected');
    }
}

function handleRangementClick(e) {
    e.stopPropagation();
    const selectedMot = document.querySelector('.mot-selected');
    if (selectedMot && e.currentTarget.children.length === 0) {
        placerMotDansRangement(selectedMot, e.currentTarget);
        selectedMot.classList.remove('mot-selected');
    }
}

function placerMotDansTrou(mot, trou) {
    // G√©rer le remplacement si le trou est occup√©
    if (trou.firstChild) {
        const motRemplace = trou.firstChild;
        const rangementVide = Array.from(rangements).find(r => r.children.length === 0);
        if (rangementVide) {
            rangementVide.appendChild(motRemplace);
        } else {
            trou.removeChild(motRemplace);
        }
        trou.classList.remove('bg-info');
    }

    // Cr√©er une copie du mot et la placer dans le trou
    const nouveauMot = document.createElement('span');
    nouveauMot.className = 'mot badge bg-primary';
    nouveauMot.setAttribute('draggable', 'true');
    nouveauMot.setAttribute('data-mot', mot.dataset.mot);
    nouveauMot.textContent = mot.textContent;

    trou.appendChild(nouveauMot);
    trou.classList.add('bg-info');

    // Supprimer l'ancien mot
    if (mot.parentNode) {
        mot.parentNode.removeChild(mot);
    }

    initDraggableMots();
}

function placerMotDansRangement(mot, rangement) {
    // Enlever le mot des trous s'il y √©tait
    trous.forEach(trou => {
        if (trou.firstChild && trou.firstChild.dataset.mot === mot.dataset.mot) {
            trou.removeChild(trou.firstChild);
            trou.classList.remove('bg-info');
        }
    });

    rangement.appendChild(mot);
    initDraggableMots();
}

// √âv√©nements drag and drop originaux pour ordinateur
initDraggableMots();
trous.forEach(trou => {
    trou.addEventListener('dragover', e => {
        e.preventDefault();
        trou.classList.add('bg-light');
    });
    trou.addEventListener('dragleave', e => {
        trou.classList.remove('bg-light');
    });
    trou.addEventListener('drop', e => {
        e.preventDefault();
        trou.classList.remove('bg-light');
        if (trou.firstChild) {
            const motRemplace = trou.firstChild;
            const rangementVide = Array.from(document.querySelectorAll('.rangement')).find(r => r.children.length === 0);
            if (rangementVide) {
                rangementVide.appendChild(motRemplace);
            } else {
                trou.removeChild(motRemplace);
            }
            trou.classList.remove('bg-info');
        }
        if (motEnCours) {
            const span = document.createElement('span');
            span.className = 'mot badge bg-primary';
            span.setAttribute('draggable', 'true');
            span.setAttribute('data-mot', motEnCours.dataset.mot);
            span.textContent = motEnCours.textContent;
            trou.appendChild(span);
            trou.classList.add('bg-info');
            if (motEnCours.parentNode) motEnCours.parentNode.removeChild(motEnCours);
            initDraggableMots();
            motEnCours = null;
        }
    });
});
// √Ä la soumission, stocker la r√©ponse dans un champ cach√©
const form = document.getElementById('formTrous');
form.addEventListener('submit', function(e) {
    const reponses = Array.from(document.querySelectorAll('.trou')).map(trou => trou.firstChild ? trou.firstChild.textContent.trim() : '');
    let input = document.getElementById('reponses_a_trous');
    if (!input) {
        input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'reponses_a_trous';
        input.id = 'reponses_a_trous';
        form.appendChild(input);
    }
    input.value = JSON.stringify(reponses);
});
function confirmerRetourAccueil() {
    if (confirm("√ätes-vous s√ªr de vouloir revenir √† l'accueil ? Votre progression sera perdue.")) {
        window.location.href = "/annuler_test_trous";
    }
}
</script>
<style>
.mot {
    cursor: grab;
    font-size: 1.1em;
    padding: 8px 16px;
    margin: 4px 0;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    transition: all 0.2s ease;
}

.mot-selected {
    background-color: #ffc107 !important;
    color: #000;
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(255, 193, 7, 0.5);
}

.trou {
    display: inline-block;
    min-width: 80px;
    min-height: 32px;
    border-bottom: 2px dashed #888;
    margin: 0 4px;
    vertical-align: middle;
    font-weight: bold;
    cursor: pointer;
    padding: 2px;
    transition: background-color 0.2s ease;
}

.rangement {
    display: inline-block;
    min-width: 100px;
    min-height: 40px;
    border: 2px solid #bbb;
    border-radius: 8px;
    background: #f8f9fa;
    margin: 0 8px 8px 0;
    text-align: center;
    vertical-align: middle;
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
}

.rangement.bg-light {
    background: #e2e6ea;
}

/* Am√©lioration pour mobile */
@media (max-width: 768px) {
    .mot {
        padding: 12px 20px;
        font-size: 1.2em;
        margin: 8px 4px;
    }

    .trou {
        min-width: 100px;
        min-height: 40px;
        padding: 8px;
        margin: 0 8px;
    }

    .rangement {
        min-width: 120px;
        min-height: 60px;
        margin: 8px;
    }

    h2 {
        font-size: 1.5rem;
    }

    .d-flex.justify-content-between {
        flex-direction: column;
        align-items: stretch;
    }

    .btn.btn-light.border {
        margin-top: 10px;
        align-self: flex-end;
    }
}

/* Instructions visuelles pour mobile */
.mobile-instructions {
    background: #e3f2fd;
    border: 1px solid #90caf9;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 20px;
    font-size: 0.9em;
    color: #1565c0;
}
</style>
{% endblock %}
