{% extends "base.html" %}

{% block title %}Administration QCM{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block sidebar collapse">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#questions" data-bs-toggle="tab">
                            üìù Questions
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#statistiques" data-bs-toggle="tab">
                            üìä Statistiques
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#export" data-bs-toggle="tab">
                            üì§ Export/Import
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main content -->
        <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">üõ†Ô∏è Administration QCM</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2" role="group">
                        <a href="{{ url_for('admin_editor') }}" class="btn btn-primary">
                            ‚úèÔ∏è √âditeur MathML Simple
                        </a>
<!--                        <a href="{{ url_for('admin_mathquill_editor') }}" class="btn btn-success">-->
<!--                            üßÆ √âditeur MathML Avanc√©-->
<!--                        </a>-->
                        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#ajouterQuestionModal">
                            ‚ûï Ajouter une question
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-outline-light">
                            üè† Retour √† l'accueil
                        </a>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <div class="alert alert-info">
                    <strong>üí° Astuce :</strong> Utilisez l'<a href="{{ url_for('admin_mathquill_editor') }}" class="alert-link">√âditeur MathML Avanc√©</a>
                    pour cr√©er des expressions math√©matiques complexes imbriqu√©es comme ‚àö(1 + ‚àöx) ou ((a+b)/(c-d))^(1/2) !
                </div>
                <div class="alert alert-success">
                    <strong>üéØ Nouveau :</strong> L'√©diteur avanc√© supporte maintenant :
                    <ul class="mb-0 mt-2">
                        <li>‚úÖ Expressions imbriqu√©es sur plusieurs niveaux</li>
                        <li>‚úÖ Interface WYSIWYG avec MathQuill</li>
                        <li>‚úÖ Conversion automatique LaTeX ‚Üî Notation personnalis√©e</li>
                        <li>‚úÖ Aper√ßu en temps r√©el</li>
                    </ul>
                </div>
            </div>

            <div class="tab-content">
                <!-- Onglet Questions -->
                <div class="tab-pane fade show active" id="questions">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <select class="form-select" id="filtreNiveau" onchange="filtrerQuestions()">
                                <option value="">Tous les niveaux</option>
                                <option value="6eme">6√®me</option>
                                <option value="5eme">5√®me</option>
                                <option value="4eme">4√®me</option>
                                <option value="3eme">3√®me</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="filtreChapitre" onchange="filtrerQuestions()">
                                <option value="">Tous les chapitres</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tableQuestions">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Probl√®me</th>
                                    <th>Niveau</th>
                                    <th>Chapitre</th>
                                    <th>Difficult√©</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Chargement dynamique via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Onglet Statistiques -->
                <div class="tab-pane fade" id="statistiques">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>üìä R√©partition par niveau</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="chartNiveau"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>üéØ R√©partition par difficult√©</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="chartDifficulte"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Onglet Export/Import -->
                <div class="tab-pane fade" id="export">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>üì§ Exporter les donn√©es</h5>
                                </div>
                                <div class="card-body">
                                    <p>Exporter toutes les questions au format JSON</p>
                                    <button class="btn btn-primary" onclick="exporterDonnees()">
                                        üì• T√©l√©charger JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5>üì• Importer des donn√©es</h5>
                                </div>
                                <div class="card-body">
                                    <form id="importForm" enctype="multipart/form-data">
                                        <div class="mb-3">
                                            <input type="file" class="form-control" id="fichierImport" accept=".json">
                                        </div>
                                        <button type="submit" class="btn btn-warning">
                                            üì§ Importer JSON
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajouter Question -->
<div class="modal fade" id="ajouterQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚ûï Ajouter une nouvelle question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="formAjouterQuestion">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Niveau</label>
                                <select class="form-select" name="niveau" required>
                                    <option value="6eme">6√®me</option>
                                    <option value="5eme">5√®me</option>
                                    <option value="4eme">4√®me</option>
                                    <option value="3eme">3√®me</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Chapitre</label>
                                <select class="form-select" name="chapitre" required>
                                    <!-- Chargement dynamique -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Difficult√©</label>
                        <select class="form-select" name="difficulte" required>
                            <option value="facile">Facile</option>
                            <option value="moyen">Moyen</option>
                            <option value="difficile">Difficile</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Probl√®me</label>
                        <textarea class="form-control" name="probleme" rows="3" required></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Option A</label>
                                <input type="text" class="form-control" name="option_a" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Option B</label>
                                <input type="text" class="form-control" name="option_b" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Option C</label>
                                <input type="text" class="form-control" name="option_c" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Option D</label>
                                <input type="text" class="form-control" name="option_d" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">R√©ponse correcte</label>
                        <select class="form-select" name="reponse_correcte" required>
                            <option value="0">Option A</option>
                            <option value="1">Option B</option>
                            <option value="2">Option C</option>
                            <option value="3">Option D</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Explication</label>
                        <textarea class="form-control" name="explication" rows="2" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">‚úÖ Ajouter</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// JavaScript pour l'administration
document.addEventListener('DOMContentLoaded', function() {
    chargerQuestions();
    chargerStatistiques();
    initialiserFormulaire();
});

function initialiserFormulaire() {
    // Chargement initial des chapitres pour le niveau par d√©faut (6√®me)
    const selectNiveau = document.querySelector('#ajouterQuestionModal select[name="niveau"]');
    const selectChapitre = document.querySelector('#ajouterQuestionModal select[name="chapitre"]');

    // √âv√©nement pour le changement de niveau
    selectNiveau.addEventListener('change', function() {
        const niveau = this.value;
        chargerChapitres(niveau, selectChapitre);
    });

    // Charger les chapitres pour le niveau par d√©faut
    if (selectNiveau.value) {
        chargerChapitres(selectNiveau.value, selectChapitre);
    }

    // Gestionnaire de soumission du formulaire
    const formAjouter = document.getElementById('formAjouterQuestion');
    formAjouter.addEventListener('submit', function(e) {
        e.preventDefault();
        ajouterQuestion();
    });

    // Initialiser les filtres de la liste principale
    initialiserFiltres();
}

function initialiserFiltres() {
    // G√©rer le changement de niveau dans les filtres
    const filtreNiveau = document.getElementById('filtreNiveau');
    const filtreChapitre = document.getElementById('filtreChapitre');

    filtreNiveau.addEventListener('change', function() {
        const niveau = this.value;

        if (niveau) {
            // Charger les chapitres pour ce niveau
            chargerChapitresPourFiltre(niveau, filtreChapitre);
        } else {
            // Remettre "Tous les chapitres" si aucun niveau s√©lectionn√©
            filtreChapitre.innerHTML = '<option value="">Tous les chapitres</option>';
        }

        // Recharger les questions avec les nouveaux filtres
        filtrerQuestions();
    });
}

function chargerChapitresPourFiltre(niveau, selectElement) {
    // Sauvegarder la valeur actuelle
    const valeurActuelle = selectElement.value;

    // Vider et afficher le chargement
    selectElement.innerHTML = '<option value="">Chargement...</option>';

    fetch(`/admin/api/chapitres/${niveau}`)
        .then(response => response.json())
        .then(data => {
            selectElement.innerHTML = '<option value="">Tous les chapitres</option>';

            if (data.chapitres && data.chapitres.length > 0) {
                data.chapitres.forEach(chapitre => {
                    const option = document.createElement('option');
                    option.value = chapitre.nom;
                    option.textContent = chapitre.titre;
                    selectElement.appendChild(option);
                });

                // Restaurer la valeur si elle existe encore
                if (valeurActuelle && [...selectElement.options].some(opt => opt.value === valeurActuelle)) {
                    selectElement.value = valeurActuelle;
                }
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des chapitres:', error);
            selectElement.innerHTML = '<option value="">Tous les chapitres</option>';
        });
}

function chargerChapitres(niveau, selectElement) {
    // Vider la liste des chapitres
    selectElement.innerHTML = '<option value="">Chargement...</option>';

    return fetch(`/admin/api/chapitres/${niveau}`)
        .then(response => response.json())
        .then(data => {
            selectElement.innerHTML = '';

            if (data.chapitres && data.chapitres.length > 0) {
                data.chapitres.forEach(chapitre => {
                    const option = document.createElement('option');
                    option.value = chapitre.nom;
                    option.textContent = chapitre.titre;
                    selectElement.appendChild(option);
                });
                return Promise.resolve(); // Retourner une Promise r√©solue
            } else {
                selectElement.innerHTML = '<option value="">Aucun chapitre disponible</option>';
                return Promise.resolve();
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des chapitres:', error);
            selectElement.innerHTML = '<option value="">Erreur de chargement</option>';
            return Promise.reject(error);
        });
}

function ajouterQuestion() {
    const form = document.getElementById('formAjouterQuestion');
    const formData = new FormData(form);

    // Convertir en objet JSON
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });

    fetch('/admin/api/question', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fermer le modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('ajouterQuestionModal'));
            modal.hide();

            // R√©initialiser le formulaire
            form.reset();

            // Recharger la liste des questions
            chargerQuestions();

            // Afficher un message de succ√®s
            alert('Question ajout√©e avec succ√®s !');
        } else {
            alert('Erreur : ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'ajout de la question');
    });
}

function chargerQuestions() {
    const filtreNiveau = document.getElementById('filtreNiveau')?.value || '';
    const filtreChapitre = document.getElementById('filtreChapitre')?.value || '';

    let url = '/admin/api/questions';
    const params = new URLSearchParams();

    if (filtreNiveau) params.append('niveau', filtreNiveau);
    if (filtreChapitre) params.append('chapitre', filtreChapitre);

    if (params.toString()) {
        url += '?' + params.toString();
    }

    fetch(url)
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#tableQuestions tbody');
            tbody.innerHTML = '';

            if (data.questions) {
                data.questions.forEach(question => {
                    const row = document.createElement('tr');

                    // Convertir le probl√®me avec MathML sans troncature
                    const problemeAvecMathML = convertirNotationVersMathML(question.probleme);

                    row.innerHTML = `
                        <td>${question.id}</td>
                        <td class="math-content" style="min-width: 200px; word-wrap: break-word;">${problemeAvecMathML}</td>
                        <td><span class="badge bg-primary">${question.niveau_nom.toUpperCase()}</span></td>
                        <td>${question.chapitre_titre}</td>
                        <td><span class="badge bg-${getDifficultyColor(question.difficulte)}">${question.difficulte}</span></td>
                        <td>
                            <a class="btn btn-sm btn-outline-success" href="/admin/editor/${question.id}" title="√âditer (vue compl√®te)">üßÆ</a>
                            <button class="btn btn-sm btn-outline-danger" onclick="supprimerQuestion(${question.id})">üóëÔ∏è</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des questions:', error);
        });
}

// Fonction pour convertir la notation personnalis√©e vers MathML avec support des expressions imbriqu√©es
function convertirNotationVersMathML(text) {
    if (!text) return text;

    // Traitement r√©cursif des expressions imbriqu√©es
    return parseNestedMathExpressions(text);
}

function parseNestedMathExpressions(text) {
    // R√©p√©ter jusqu'√† ce qu'il n'y ait plus d'expressions √† traiter
    let previousText = '';
    let currentText = text;

    while (previousText !== currentText) {
        previousText = currentText;

        // Traiter les expressions de l'int√©rieur vers l'ext√©rieur
        // D'abord les expressions les plus simples (sans imbrication)
        currentText = currentText
            .replace(/\[sqrt:([^\[\]]+)\]/g, function(match, value) {
                const parsedValue = parseInnerExpression(value.trim());
                return `<math class="math-inline"><msqrt>${parsedValue}</msqrt></math>`;
            })
            .replace(/\[pow:([^\[\]]+)\]/g, function(match, expr) {
                if (expr.includes('^')) {
                    const [base, exp] = expr.split('^');
                    const parsedBase = parseInnerExpression(base.trim());
                    const parsedExp = parseInnerExpression(exp.trim());
                    return `<math class="math-inline"><msup>${parsedBase}${parsedExp}</msup></math>`;
                }
                return match;
            })
            .replace(/\[root:([^\[\]]+)\]/g, function(match, values) {
                const parts = values.split(',');
                if (parts.length === 2) {
                    const parsedRadicande = parseInnerExpression(parts[0].trim());
                    const parsedIndice = parseInnerExpression(parts[1].trim());
                    return `<math class="math-inline"><mroot>${parsedRadicande}${parsedIndice}</mroot></math>`;
                }
                return match;
            })
            .replace(/\[var:([^\[\]]+)\]/g, function(match, variable) {
                if (variable.includes('_')) {
                    const [nom, indice] = variable.split('_');
                    return `<math class="math-inline"><msub><mi>${nom.trim()}</mi><mn>${indice.trim()}</mn></msub></math>`;
                } else {
                    return `<math class="math-inline"><mi>${variable.trim()}</mi></math>`;
                }
            });

        // Traiter les fractions avec un algorithme sp√©cial pour les expressions imbriqu√©es
        currentText = parseFractions(currentText);
    }

    return currentText;
}

function parseFractions(text) {
    // Rechercher toutes les occurrences de [frac:...] avec gestion des crochets imbriqu√©s
    let result = text;
    let index = 0;

    while (index < result.length) {
        const fracStart = result.indexOf('[frac:', index);
        if (fracStart === -1) break;

        const contentStart = fracStart + 6; // longueur de '[frac:'
        let bracketCount = 1;
        let contentEnd = contentStart;

        // Trouver la fin de l'expression en comptant les crochets
        while (contentEnd < result.length && bracketCount > 0) {
            if (result[contentEnd] === '[') {
                bracketCount++;
            } else if (result[contentEnd] === ']') {
                bracketCount--;
            }
            contentEnd++;
        }

        if (bracketCount === 0) {
            const fracContent = result.substring(contentStart, contentEnd - 1);

            if (fracContent.includes('/')) {
                // Trouver la position du / en tenant compte des crochets imbriqu√©s
                const slashPos = findMainSlash(fracContent);
                if (slashPos !== -1) {
                    const num = fracContent.substring(0, slashPos).trim();
                    const den = fracContent.substring(slashPos + 1).trim();
                    const parsedNum = parseInnerExpression(num);
                    const parsedDen = parseInnerExpression(den);

                    const replacement = `<math class="math-inline"><mfrac>${parsedNum}${parsedDen}</mfrac></math>`;
                    result = result.substring(0, fracStart) + replacement + result.substring(contentEnd);
                    index = fracStart + replacement.length;
                } else {
                    index = contentEnd;
                }
            } else {
                index = contentEnd;
            }
        } else {
            break;
        }
    }

    return result;
}

function findMainSlash(content) {
    // Trouver la position du / principal (pas dans des crochets imbriqu√©s)
    let bracketCount = 0;
    for (let i = 0; i < content.length; i++) {
        if (content[i] === '[') {
            bracketCount++;
        } else if (content[i] === ']') {
            bracketCount--;
        } else if (content[i] === '/' && bracketCount === 0) {
            return i;
        }
    }
    return -1;
}

function parseInnerExpression(expr) {
    // Si l'expression contient du MathML d√©j√† pars√©, l'extraire
    if (expr.includes('<math class="math-inline">')) {
        // Extraire le contenu entre <math> et </math>
        const mathMatch = expr.match(/<math class="math-inline">(.*?)<\/math>/);
        if (mathMatch) {
            return mathMatch[1];
        }
    }

    // G√©rer les divisions avec / pour les fractions
    if (expr.includes('/') && !expr.includes('<m')) {
        const parts = expr.split('/');
        if (parts.length === 2) {
            const num = parseInnerExpression(parts[0].trim());
            const den = parseInnerExpression(parts[1].trim());
            return `<mfrac>${num}${den}</mfrac>`;
        }
    }

    // Si c'est un nombre simple
    if (/^-?\d+(\.\d+)?$/.test(expr)) {
        return `<mn>${expr}</mn>`;
    }

    // Si c'est une variable simple
    if (/^[a-zA-Z]$/.test(expr)) {
        return `<mi>${expr}</mi>`;
    }

    // Variables avec plusieurs caract√®res
    if (/^[a-zA-Z_]\w*$/.test(expr)) {
        return `<mi>${expr}</mi>`;
    }

    // Par d√©faut, traiter comme du texte
    return `<mn>${expr}</mn>`;
}

// Fonction pour tronquer intelligemment un texte contenant du MathML
function tronquerProblemeAvecMathML(texte, maxLength) {
    if (!texte) return '';

    // Si le texte est court, le retourner tel quel
    if (texte.length <= maxLength) {
        return texte;
    }

    // Pour les textes longs, essayer de couper intelligemment
    // √âviter de couper au milieu d'une balise MathML
    let index = maxLength;

    // Si on est au milieu d'une balise math, reculer jusqu'au d√©but
    if (texte.substring(0, index).includes('<math') && !texte.substring(0, index).includes('</math>')) {
        const lastMathStart = texte.substring(0, index).lastIndexOf('<math');
        if (lastMathStart > maxLength * 0.5) { // Si la balise math n'est pas trop loin
            index = lastMathStart;
        }
    }

    return texte.substring(0, index) + '...';
}

function filtrerQuestions() {
    chargerQuestions();
}

function getDifficultyColor(difficulte) {
    switch(difficulte) {
        case 'facile': return 'success';
        case 'moyen': return 'warning';
        case 'difficile': return 'danger';
        default: return 'secondary';
    }
}

function supprimerQuestion(id) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cette question ?')) {
        fetch(`/admin/api/question/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                chargerQuestions();
                alert('Question supprim√©e avec succ√®s');
            } else {
                alert('Erreur : ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la suppression');
        });
    }
}

function chargerStatistiques() {
    fetch('/admin/api/statistiques')
        .then(response => response.json())
        .then(data => {
            // TODO: Cr√©er les graphiques avec Chart.js
            console.log('Statistiques charg√©es:', data);
        })
        .catch(error => {
            console.error('Erreur lors du chargement des statistiques:', error);
        });
}

function exporterDonnees() {
    // TODO: Impl√©menter l'export
    alert('Fonctionnalit√© d\'export √† impl√©menter');
}
</script>

<!-- Ajout MathLive si non inclus -->
<script src="https://unpkg.com/mathlive/dist/mathlive.min.js"></script>
{% endblock %}
