{% extends "base.html" %}

{% block title %}{{ contexte }} - Question {{ question_num }}/{{ total_questions }} - Tests de Math√©matiques{% endblock %}

{% block canonical %}
<link rel="canonical" href="https://mathsetco.eu.pythonanywhere.com/niveau/{{ niveau }}" />
{% endblock %}

{% block meta_description %}
<meta name="description" content="Test de math√©matiques {{ niveau|upper }} - Question {{ question_num }} sur {{ total_questions }}. QCM interactif avec corrections d√©taill√©es pour le coll√®ge." />
{% endblock %}

{% block og_title %}Test de Math√©matiques {{ niveau|upper }} | MathœÄSetüéæ&Co{% endblock %}
{% block og_description %}QCM de math√©matiques niveau {{ niveau|upper }} avec corrections d√©taill√©es - Question {{ question_num }}/{{ total_questions }}{% endblock %}

{% block twitter_title %}Test Maths {{ niveau|upper }} - Question {{ question_num }}/{{ total_questions }}{% endblock %}
{% block twitter_description %}QCM interactif de math√©matiques niveau {{ niveau|upper }} avec corrections{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Quiz",
  "name": "Test de Math√©matiques {{ niveau|upper }}",
  "description": "QCM de math√©matiques niveau {{ niveau|upper }} avec corrections d√©taill√©es",
  "educationalLevel": "{{ niveau }}",
  "learningResourceType": "Quiz",
  "interactivityType": "active",
  "typicalAgeRange": "{% if niveau == '6eme' %}11-12{% elif niveau == '5eme' %}12-13{% elif niveau == '4eme' %}13-14{% else %}14-15{% endif %}",
  "inLanguage": "fr",
  "provider": {
    "@type": "EducationalOrganization",
    "name": "MathœÄSet&Co",
    "url": "https://mathsetco.eu.pythonanywhere.com/"
  },
  "about": {
    "@type": "Thing",
    "name": "Math√©matiques",
    "description": "Math√©matiques niveau coll√®ge {{ niveau }}"
  }
}
</script>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-primary text-white">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">Niveau {{ niveau|upper }} - Question {{ question_num }}/{{ total_questions }}</h5>
            </div>
            <div class="col-auto">
                <div class="progress" style="width: 200px; height: 10px;">
                    <div class="progress-bar bg-warning" role="progressbar"
                         style="width: {{ (question_num / total_questions * 100)|round }}%">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-body p-5">
        <div class="mb-4">
            <h4 class="text-primary mb-3">üìù Probl√®me √† r√©soudre :</h4>
            <div class="alert alert-light border-start border-primary border-4 fs-5 math-content">
                {{ question.probleme|mathml|safe }}
            </div>
        </div>

        <form method="POST" action="{{ url_for('repondre') }}">
            <div class="mb-4">
                <h5 class="text-secondary mb-3">Choisissez votre r√©ponse :</h5>

                {% for i in range(question.options|length) %}
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="reponse"
                           id="option{{ i }}" value="{{ i }}" required
                           {% if session.get('reponses_dict', {}).get((question_num - 1)|string, {}).get('reponse_utilisateur') == i %}checked{% endif %}>
                    <label class="form-check-label fs-6 math-content" for="option{{ i }}">
                        <span class="badge bg-light text-dark me-2">{{ ['A', 'B', 'C', 'D'][i] }}</span>
                        {{ question.options[i]|mathml_clean|safe }}
                    </label>
                </div>
                {% endfor %}
            </div>

            <div class="row mt-4">
                <!-- Bouton Retour √† gauche -->
                <div class="col-md-4 d-flex justify-content-start">
                    {% if session.get('mode') == 'chapitre' %}
                    <button type="button" class="btn btn-outline-secondary btn-lg px-4" onclick="confirmerSortieTest('chapitre')" title="Retour aux chapitres">
                        <i class="fas fa-home me-2"></i>Retour aux chapitres
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-outline-secondary btn-lg px-4" onclick="confirmerSortieTest('niveau')" title="Retour √† l'accueil">
                        <i class="fas fa-home me-2"></i>Retour √† l'accueil
                    </button>
                    {% endif %}
                </div>

                <!-- Bouton Question pr√©c√©dente au centre -->
                <div class="col-md-4 d-flex justify-content-center">
                    {% if question_num > 1 %}
                    <a href="{{ url_for('question_precedente') }}" class="btn btn-outline-primary btn-lg px-4" title="Revenir √† la question pr√©c√©dente">
                        <i class="fas fa-arrow-left me-2"></i>Question pr√©c√©dente
                    </a>
                    {% else %}
                    <!-- Espace r√©serv√© pour maintenir l'alignement -->
                    <div class="invisible btn btn-lg px-4">Placeholder</div>
                    {% endif %}
                </div>

                <!-- Bouton Question suivante √† droite -->
                <div class="col-md-4 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary btn-lg px-4" title="{% if question_num == total_questions %}Terminer le test{% else %}Passer √† la question suivante{% endif %}">
                        {% if question_num == total_questions %}
                            <i class="fas fa-check-circle me-2"></i>Terminer le test
                        {% else %}
                            Question suivante<i class="fas fa-arrow-right ms-2"></i>
                        {% endif %}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Auto-focus sur le premier choix pour une meilleure UX
document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('input[name="reponse"]').focus();
});

// Permettre la navigation avec les touches num√©riques
document.addEventListener('keydown', function(e) {
    if (e.key >= '1' && e.key <= '4') {
        const index = parseInt(e.key) - 1;
        const radio = document.querySelector(`input[name="reponse"][value="${index}"]`);
        if (radio) {
            radio.checked = true;
        }
    }
});

function confirmerSortieTest(type) {
    const destination_text = type === 'chapitre' ? 'aux chapitres' : '√† l\'accueil';

    // Cr√©er une bo√Æte de dialogue personnalis√©e
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;

    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <h4 style="color: #dc3545; margin-bottom: 20px;">‚ö†Ô∏è Quitter le test</h4>
            <p style="margin-bottom: 25px; font-size: 16px;">
                Que souhaitez-vous faire avec votre progression actuelle ?
            </p>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button id="saveAndExit" class="btn btn-success" style="width: 100%; padding: 12px;">
                    üíæ Sauvegarder et retourner ${destination_text}
                </button>
                <button id="exitWithoutSave" class="btn btn-warning" style="width: 100%; padding: 12px;">
                    üö™ Quitter sans sauvegarder
                </button>
                <button id="cancelExit" class="btn btn-secondary" style="width: 100%; padding: 12px;">
                    ‚ùå Annuler
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Gestionnaires d'√©v√©nements
    document.getElementById('saveAndExit').onclick = function() {
        document.body.removeChild(modal);
        sauvegarderEtQuitter(type);
    };

    document.getElementById('exitWithoutSave').onclick = function() {
        document.body.removeChild(modal);
        quitterSansSauvegarder(type);
    };

    document.getElementById('cancelExit').onclick = function() {
        document.body.removeChild(modal);
    };

    // Fermer avec Escape
    modal.onkeydown = function(e) {
        if (e.key === 'Escape') {
            document.body.removeChild(modal);
        }
    };

    // Focus sur le modal pour les √©v√©nements clavier
    modal.setAttribute('tabindex', '0');
    modal.focus();
}

function sauvegarderEtQuitter(type) {
    const destination = type === 'chapitre' ? 'chapitres_niveau' : 'index';

    // Appel AJAX pour sauvegarder la progression
    fetch('/sauvegarder_et_quitter', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            destination: destination
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect_url;
        } else {
            console.error('Erreur lors de la sauvegarde:', data.error);
            // Redirection quand m√™me en cas d'erreur
            const url = type === 'chapitre' ?
                "{{ url_for('chapitres_niveau', niveau=niveau) }}" :
                "{{ url_for('index') }}";
            window.location.href = url;
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        // Redirection en cas d'erreur r√©seau
        const url = type === 'chapitre' ?
            "{{ url_for('chapitres_niveau', niveau=niveau) }}" :
            "{{ url_for('index') }}";
        window.location.href = url;
    });
}

function quitterSansSauvegarder(type) {
    // Redirection directe sans sauvegarde
    const url = type === 'chapitre' ?
        "{{ url_for('chapitres_niveau', niveau=niveau) }}" :
        "{{ url_for('index') }}";
    window.location.href = url;
}
</script>
{% endblock %}
